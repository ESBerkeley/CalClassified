{% extends 'profile/profile.html' %}

{% block profile_title %} <a href="{{ post.get_absolute_url }}">{{ thread.post_title }} {% if thread.post_deleted %}(Post Deleted){%endif%}</a> {% endblock %}

{% block title %} Messages - {{ thread.post_title }} {% if thread.post_deleted %}(Post Deleted){%endif%} {% endblock %}

{% block profile_content %}
<div>
  <button class="btn contact-button btn-info" data-toggle="modal" href="#contact-modal"><i class="icon-share-alt icon-white"></i> Reply </button>
  <br><br>
  <div class="modal fade hide msg-modal" id="contact-modal">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal"><i class="icon-remove"></i></button>
        <h3>Reply</h3>
    </div>
    <div class="modal-body">
      <textarea autocomplete="off" class="input-xlarge field span7" id="modal-message" rows="5" style="height:300px;"></textarea>
    </div>
    <div class="modal-footer">
      <button id="modal-send" class="btn btn-primary" data-loading-text="Sending...">Send</button>
      <button class="btn" data-dismiss="modal">Close</button>
    </div>
  </div>
    
  <!-- this modal activates when message is sent -->
  <div class="modal fade hide" id="success-modal">
    <div class="modal-header">
      <button type="button" class="close close-refresh" data-dismiss="modal"><i class="icon-remove"></i></button>
        <h3>Reply</h3>
    </div>
    <div class="modal-body">
      <p> Message Sent! </p>
    </div>
    <div class="modal-footer">
      <button class="btn close-refresh" data-dismiss="modal">Close</button>
    </div>
  </div>

  <table class="table table-hover table-bordered">
    <tbody>
      {% for message in messages %}
        <tr>
          <td>
            {% if message.sender == request.user %}
              <b> Me </b>
            {% else %}
              <b><a href="{% url user message.sender.id %}">{{ message.sender.first_name }} {{ message.sender.last_name }}</a></b>
            {% endif %}
            <br> 
            {{ message.time_created }}
            <br>
            <p style="white-space:pre-wrap; line-height: 19px;">{{ message.body }}</p>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_owner %}
    <div class="modal fade hide" id="confirm-modal">
        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="icon-remove"></i></button>
        <h3>Confirm Transaction</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to mark this transaction complete?</p> 
      </div>
      <div class="modal-footer">
        <a id="confirm-yes" class="btn btn-primary" type="button"  href = "/modify_post?post_pk={{ thread.post_id }}&action=done">Done!</a>
        <button class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </div>

    <div class="modal fade hide" id="repost-modal">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><i class="icon-remove"></i></button>
        <h3>Confirm Repost</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to give up on the current buyer and repost the item?</p>
      </div>
      <div class="modal-footer">
        <a id="confirm-yes" class="btn btn-primary" type="button"  href = "/modify_post?post_pk={{ thread.post_id }}&action=repost">Repost Item</a>
        <button class="btn" data-dismiss="modal">Cancel</button>
      </div>
    </div>

    {% if post.pending_flag and not post.sold %}
      <div>
        <h3>Have you sold your item?</h3>
        <p style="font-size:14px; font-weight:bold; margin-top:-12px; margin-bottom:15px;">If it didn't work out, we can repost this item for you automatically.<p>
        <a class="btn btn-primary" data-toggle="modal" data-target="#confirm-modal" style="margin-right:10px;">Sold It</a>       
        <a class="btn" data-toggle="modal" data-target="#repost-modal">Didn't work out</a>
      </div>
    {% else %}
      This sale is complete.
    {% endif %}

  {% else %}
    {% if post.sold %}
      This sale has been marked completed by the seller.
    {% else %}
      This sale is currently pending, and has not been marked complete by the seller.
    {% endif %}
  {% endif %}   
</div>
{% endblock %}

{% block pre_js %}
<script type="text/javascript">
  var post_pk = "{{ thread.post_id }}";
  var csrf_token = "{{ csrf_token }}";
  var recipient_pk = "{{ thread.other_person.pk }}";
</script>
{% endblock %}

{% block post_js %}
  <script type="text/javascript">
    $(document).ready( function() {
      $("#messages-tab").addClass("active");
      // refresh the page after sending msg
      $(".close-refresh").click (function() {
        location.reload();
      });
      $('#contact-modal').on('shown', function () {
        $('#modal-message').focus();
      });
    });
  </script>
{% endblock %}
